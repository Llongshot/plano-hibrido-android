name: Build Android APK (Alternative)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git \
          zip \
          unzip \
          openjdk-17-jdk \
          python3-pip \
          autoconf \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo5 \
          cmake \
          libffi-dev \
          libssl-dev \
          build-essential \
          ccache \
          libffi8 \
          libltdl-dev

    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install buildozer cython==0.29.33

    - name: Cache Buildozer global directory
      uses: actions/cache@v4
      with:
        path: ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    - name: Cache Buildozer dependencies
      uses: actions/cache@v4
      with:
        path: .buildozer
        key: ${{ runner.os }}-buildozer-deps-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-deps-

    - name: Build APK with Buildozer
      run: |
        # Ensure we have the latest buildozer
        buildozer --version
        
        # Build the APK
        buildozer android debug
        
        # List generated files
        ls -la bin/

    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: plano-hibrido-apk-${{ github.run_number }}
        path: bin/*.apk
        retention-days: 30

    - name: Get APK info
      run: |
        if [ -f bin/*.apk ]; then
          APK_FILE=$(ls bin/*.apk | head -1)
          APK_SIZE=$(du -h "$APK_FILE" | cut -f1)
          echo "APK_FILE=$APK_FILE" >> $GITHUB_ENV
          echo "APK_SIZE=$APK_SIZE" >> $GITHUB_ENV
          echo "APK generated: $APK_FILE (Size: $APK_SIZE)"
        fi

    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.0.${{ github.run_number }}
        name: ğŸ‹ï¸ Plano HÃ­brido v1.0.${{ github.run_number }}
        body: |
          ## ğŸ‹ï¸ Plano HÃ­brido 8 Semanas - Android APK
          
          **ğŸ“± Nova versÃ£o disponÃ­vel!**
          
          ### âœ¨ Funcionalidades:
          - â±ï¸ Timer visual para exercÃ­cios
          - ğŸ¥ VÃ­deos do YouTube integrados
          - ğŸ“Š Progresso e notas persistentes
          - ğŸ“º Interface otimizada para Android TV
          - ğŸ”„ 8 semanas de progressÃ£o automÃ¡tica
          
          ### ğŸ“¥ InstalaÃ§Ã£o:
          1. Baixe o APK abaixo
          2. Ative "Fontes desconhecidas" no Android
          3. Instale o APK
          4. Comece a treinar! ğŸ’ª
          
          ### ğŸ¯ Compatibilidade:
          - Android 5.0+ (API 21+)
          - Android TV âœ…
          - Smartphones e tablets âœ…
          
          ### ğŸ“Š InformaÃ§Ãµes tÃ©cnicas:
          - Tamanho: ${{ env.APK_SIZE }}
          - Build: #${{ github.run_number }}
          - Commit: ${{ github.sha }}
          
          ---
          
          **ğŸš€ Desenvolvido com Kivy + Buildozer**
        files: bin/*.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ğŸ‰ APK build completed successfully! Download it from the [Actions artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).'
          })